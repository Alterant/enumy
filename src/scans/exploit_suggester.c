/*
    This file will use uname to get the kernel version and OS. Based off this information we 
    can surgest possible POC exploits 

    Follow the steps in the comments to add an exploit
*/

#include <errno.h>
#include <stdio.h>
#include <string.h>
#include <sys/utsname.h>

#include "debug.h"
#include "error_logger.h"
#include "file_system.h"
#include "main.h"
#include "results.h"

/* ============================ STRUCTS ============================== */

/* Stuct for a single exploit */
typedef struct PossibleExploit
{
    const char **vuln_versions;   /* Array of known vulnerablie kernel versions */
    const char *name;             /* Name of the vulnerability */
    const char *cve;              /* The CVE for the vulnerability if it has one */
    const char *url;              /* The URL to the POC exploit if it has one */
    const unsigned int vul_count; /* Size of vuln_versions */
} PossibleExploit;

/* ============================ CONSTS ============================== */

/* Below is a bunch of hardcoded set of vulnerable kernel versions that relate to a single exploit */
/* STEP 1: create a const char *[] of known vulnerable kerenel versions */

const char *Woot[] = {"2.4.10", "2.4.16", "2.4.17", "2.4.18", "2.4.19", "2.4.20", "2.4.21"};
const char *Brk[] = {"2.4.10", "2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22"};
const char *Ave[] = {"2.4.19", "2.4.20"};
const char *Elflbl[] = {"2.4.29"};
const char *ElfDump[] = {"2.4.27"};
const char *Elfcd[] = {"2.6.12"};
const char *ExpandStack[] = {"2.4.29"};
const char *H00lyShit[] = {"2.6.8", "2.6.10", "2.6.11", "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16"};
const char *Kdump[] = {"2.6.13"};
const char *Km2[] = {"2.4.18", "2.4.22"};
const char *Krad[] = {"2.6.5", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11"};
const char *Krad3[] = {"2.6.5", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11"};
const char *Local26[] = {"2.6.13"};
const char *Loko[] = {"2.4.22", "2.4.23", "2.4.24"};
const char *Mremap_pte[] = {"2.4.20", "2.2.24", "2.4.25", "2.4.26", "2.4.27"};
const char *NewLocal[] = {"2.4.17", "2.4.19"};
const char *OngBak[] = {"2.6.5"};
const char *Ptrace[] = {"2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22"};
const char *PtraceKmod[] = {"2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22"};
const char *PtraceKmod2[] = {"2.6.26", "2.6.27", "2.6.28", "2.6.29", "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34"};
const char *Ptrace24[] = {"2.4.9"};
const char *Pwned[] = {"2.6.11"};
const char *Py2[] = {"2.6.9", "2.6.17", "2.6.15", "2.6.13"};
const char *RaptorPrctl[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Prctl[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Prctl2[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Prctl3[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Prctl4[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Remap[] = {"2.4"};
const char *Rip[] = {"2.2"};
const char *StackGrow2[] = {"2.4.29", "2.6.10"};
const char *UseLib24[] = {"2.6.10", "2.4.17", "2.4.22", "2.4.25", "2.4.27", "2.4.29"};
const char *Newsmp[] = {"2.6"};
const char *Snptracer[] = {"2.4.29"};
const char *Loginx[] = {"2.4.22"};
const char *ExpSh[] = {"2.6.9", "2.6.10", "2.6.16", "2.6.13"};
const char *Vmsplice1[] = {"2.6.17", "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23", "2.6.24", "2.6.24.1"};
const char *Vmsplice2[] = {"2.6.23", "2.6.24"};
const char *Vconsole[] = {"2.6"};
const char *Sctp[] = {"2.6.26"};

const char *Ftrex[] = {"2.6.11", "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17", "2.6.18", "2.6.19",
                       "2.6.20", "2.6.21", "2.6.22"};

const char *ExitNotify[] = {"2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29"};
const char *Udev[] = {"2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29"};

const char *SockSendPage2[] = {"2.4.4", "2.4.5", "2.4.6", "2.4.7", "2.4.8", "2.4.9", "2.4.10", "2.4.11", "2.4.12",
                               "2.4.13", "2.4.14", "2.4.15", "2.4.16", "2.4.17", "2.4.18", "2.4.19", "2.4.20", "2.4.21",
                               "2.4.22", "2.4.23", "2.4.24", "2.4.25", "2.4.26", "2.4.27", "2.4.28", "2.4.29", "2.4.30",
                               "2.4.31", "2.4.32", "2.4.33", "2.4.34", "2.4.35", "2.4.36", "2.4.37", "2.6.0", "2.6.1",
                               "2.6.2", "2.6.3", "2.6.4", "2.6.5", "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                               "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17", "2.6.18", "2.6.19", "2.6.20",
                               "2.6.21", "2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29", "2.6.30"};

const char *SockSendPage[] = {"2.4.4", "2.4.5", "2.4.6", "2.4.7", "2.4.8", "2.4.9", "2.4.10", "2.4.11", "2.4.12", "2.4.13",
                              "2.4.14", "2.4.15", "2.4.16", "2.4.17", "2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22", "2.4.23",
                              "2.4.24", "2.4.25", "2.4.26", "2.4.27", "2.4.28", "2.4.29", "2.4.30", "2.4.31", "2.4.32", "2.4.33",
                              "2.4.34", "2.4.35", "2.4.36", "2.4.37", "2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5", "2.6.6",
                              "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11", "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16",
                              "2.6.17", "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26",
                              "2.6.27", "2.6.28", "2.6.29", "2.6.30"};

const char *UdpSendMsg32Bit[] = {"2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5", "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                                 "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17", "2.6.18", "2.6.19"};

const char *PipeC32Bit[] = {"2.4.4", "2.4.5", "2.4.6", "2.4.7", "2.4.8", "2.4.9", "2.4.10", "2.4.11", "2.4.12", "2.4.13", "2.4.14",
                            "2.4.15", "2.4.16", "2.4.17", "2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22", "2.4.23", "2.4.24",
                            "2.4.25", "2.4.26", "2.4.27", "2.4.28", "2.4.29", "2.4.30", "2.4.31", "2.4.32", "2.4.33", "2.4.34",
                            "2.4.35", "2.4.36", "2.4.37", "2.6.15", "2.6.16", "2.6.17", "2.6.18", "2.6.19", "2.6.20", "2.6.21",
                            "2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29", "2.6.30", "2.6.31"};

const char *DoPageMove[] = {"2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27",
                            "2.6.28", "2.6.29", "2.6.30", "2.6.31"};

const char *Reiserfs[] = {"2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                          "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                          "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34"};

const char *CanBcm[] = {"2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                        "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                        "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                        "2.6.36"};

const char *Rds[] = {"2.6.30", "2.6.31", "2.6.32", "2.6.33",
                     "2.6.34", "2.6.35", "2.6.36"};

const char *HalfNelson1[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                             "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                             "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                             "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                             "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                             "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                             "2.6.36"};

const char *HalfNelson2[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                             "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                             "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                             "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                             "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                             "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                             "2.6.36"};
const char *HalfNelson3[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                             "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                             "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                             "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                             "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                             "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                             "2.6.36"};
const char *CapsToRoot[] = {"2.6.34", "2.6.35", "2.6.36"};

const char *AmericanSignLanguage[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                                      "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                                      "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                                      "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                                      "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                                      "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                                      "2.6.36"};

const char *Pktcdvd[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                         "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                         "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                         "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                         "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                         "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                         "2.6.36"};

const char *Video4Linux[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                             "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                             "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                             "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                             "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                             "2.6.30", "2.6.31", "2.6.32", "2.6.33"};

const char *Memodipper[] = {"2.6.39", "3.0.0", "3.0.1", "3.0.2", "3.0.3", "3.0.4",
                            "3.0.5", "3.0.6", "3.1.0"};

const char *SemTex[] = {"2.6.37", "2.6.38", "2.6.39", "3.0.0", "3.0.1", "3.0.2",
                        "3.0.3", "3.0.4", "3.0.5", "3.0.6", "3.1.0"};

const char *PerfSwevent[] = {"3.0.0", "3.0.1", "3.0.2", "3.0.3", "3.0.4", "3.0.5",
                             "3.0.6", "3.1.0", "3.2.0", "3.3.0", "3.4.0", "3.4.1",
                             "3.4.2", "3.4.3", "3.4.4", "3.4.5", "3.4.6", "3.4.8",
                             "3.4.9", "3.5.0", "3.6.0", "3.7.0", "3.8.0", "3.8.1",
                             "3.8.2", "3.8.3", "3.8.4", "3.8.5", "3.8.6", "3.8.7",
                             "3.8.8", "3.8.9"};

const char *Msr[] = {"2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                     "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.27", "2.6.28",
                     "2.6.29", "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34",
                     "2.6.35", "2.6.36", "2.6.37", "2.6.38", "2.6.39", "3.0.0",
                     "3.0.1", "3.0.2", "3.0.3", "3.0.4", "3.0.5", "3.0.6",
                     "3.1.0", "3.2.0", "3.3.0", "3.4.0", "3.5.0", "3.6.0",
                     "3.7.0", "3.7.6"};

const char *TimeOutPwn[] = {"3.4.0", "3.5.0", "3.6.0", "3.7.0", "3.8.0", "3.8.9",
                            "3.9.0", "3.10.0", "3.11.0", "3.12.0", "3.13.0", "3.4.0",
                            "3.5.0", "3.6.0", "3.7.0", "3.8.0", "3.8.5", "3.8.6",
                            "3.8.9", "3.9.0", "3.9.6", "3.10.0", "3.10.6", "3.11.0",
                            "3.12.0", "3.13.0", "3.13.1"};

const char *RawModePTY[] = {"2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35", "2.6.36",
                            "2.6.37", "2.6.38", "2.6.39", "3.14.0", "3.15.0"};

const char *Overlayfs[] = {"3.13.0", "3.16.0", "3.19.0"};

const char *PPKey[] = {"3.4.0", "3.5.0", "3.6.0", "3.7.0", "3.8.0", "3.8.1",
                       "3.8.2", "3.8.3", "3.8.4", "3.8.5", "3.8.6", "3.8.7",
                       "3.8.8", "3.8.9", "3.9.0", "3.9.6", "3.10.0", "3.10.6",
                       "3.11.0", "3.12.0", "3.13.0", "3.13.1"};

const char *DirtyCow[] = {"2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27",
                          "2.6.27", "2.6.28", "2.6.29", "2.6.30", "2.6.31", "2.6.32",
                          "2.6.33", "2.6.34", "2.6.35", "2.6.36", "2.6.37", "2.6.38",
                          "2.6.39", "3.0.0", "3.0.1", "3.0.2", "3.0.3", "3.0.4",
                          "3.0.5", "3.0.6", "3.1.0", "3.2.0", "3.3.0", "3.4.0",
                          "3.5.0", "3.6.0", "3.7.0", "3.7.6", "3.8.0", "3.9.0",
                          "3.10.0", "3.11.0", "3.12.0", "3.13.0", "3.14.0", "3.15.0",
                          "3.16.0", "3.17.0", "3.18.0", "3.19.0", "4.0.0", "4.1.0",
                          "4.2.0", "4.3.0", "4.4.0", "4.5.0", "4.6.0", "4.7.0"};

const char *AfPacket[] = {"4.4.0"};
const char *PacketSetRing[] = {"4.8.0"};

const char *CloneNewUser[] = {"3.3.5", "3.3.4", "3.3.2", "3.2.13", "3.2.9", "3.2.1",
                              "3.1.8", "3.0.5", "3.0.4", "3.0.2", "3.0.1", "3.2", "3.0.1", "3.0"};

const char *GetRekt[] = {"4.4.0", "4.8.0", "4.10.0", "4.13.0"};
const char *ExploitX[] = {"2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27",
                          "2.6.27", "2.6.28", "2.6.29", "2.6.30", "2.6.31", "2.6.32",
                          "2.6.33", "2.6.34", "2.6.35", "2.6.36", "2.6.37", "2.6.38",
                          "2.6.39", "3.0.0", "3.0.1", "3.0.2", "3.0.3", "3.0.4",
                          "3.0.5", "3.0.6", "3.1.0", "3.2.0", "3.3.0", "3.4.0",
                          "3.5.0", "3.6.0", "3.7.0", "3.7.6", "3.8.0", "3.9.0",
                          "3.10.0", "3.11.0", "3.12.0", "3.13.0", "3.14.0", "3.15.0",
                          "3.16.0", "3.17.0", "3.18.0", "3.19.0", "4.0.0", "4.1.0",
                          "4.2.0", "4.3.0", "4.4.0", "4.5.0", "4.6.0", "4.7.0"};

/* ============================ Static Structs ============================== */

/* STEP 2: Calculate the number of effected kernel versions for each exploit */

const unsigned int WootSize = sizeof(Woot) / sizeof(Woot[0]);
const unsigned int BrkSize = sizeof(Brk) / sizeof(Brk[0]);
const unsigned int AveSize = sizeof(Ave) / sizeof(Ave[0]);
const unsigned int ElflblSize = sizeof(Elflbl) / sizeof(Elflbl[0]);
const unsigned int ElfDumpSize = sizeof(ElfDump) / sizeof(ElfDump[0]);
const unsigned int ElfcdSize = sizeof(Elfcd) / sizeof(Elfcd[0]);
const unsigned int ExpandStackSize = sizeof(ExpandStack) / sizeof(ExpandStack[0]);
const unsigned int H00lyShitSize = sizeof(H00lyShit) / sizeof(H00lyShit[0]);
const unsigned int KdumpSize = sizeof(Kdump) / sizeof(Kdump[0]);
const unsigned int Km2Size = sizeof(Km2) / sizeof(Km2[0]);
const unsigned int KradSize = sizeof(Krad) / sizeof(Krad[0]);
const unsigned int Krad3Size = sizeof(Krad3) / sizeof(Krad3[0]);
const unsigned int Local26Size = sizeof(Local26) / sizeof(Local26[0]);
const unsigned int LokoSize = sizeof(Loko) / sizeof(Loko[0]);
const unsigned int Mremap_pteSize = sizeof(Mremap_pte) / sizeof(Mremap_pte[0]);
const unsigned int NewLocalSize = sizeof(NewLocal) / sizeof(NewLocal[0]);
const unsigned int OngBakSize = sizeof(OngBak) / sizeof(OngBak[0]);
const unsigned int PtraceSize = sizeof(Ptrace) / sizeof(Ptrace[0]);
const unsigned int PtraceKmodSize = sizeof(PtraceKmod) / sizeof(PtraceKmod[0]);
const unsigned int PtraceKmod2Size = sizeof(PtraceKmod2) / sizeof(PtraceKmod2[0]);
const unsigned int Ptrace24Size = sizeof(Ptrace24) / sizeof(Ptrace24[0]);
const unsigned int PwnedSize = sizeof(Pwned) / sizeof(Pwned[0]);
const unsigned int Py2Size = sizeof(Py2) / sizeof(Py2[0]);
const unsigned int RaptorPrctlSize = sizeof(RaptorPrctl) / sizeof(RaptorPrctl[0]);
const unsigned int PrctlSize = sizeof(Prctl) / sizeof(Prctl[0]);
const unsigned int Prctl2Size = sizeof(Prctl2) / sizeof(Prctl2[0]);
const unsigned int Prctl3Size = sizeof(Prctl3) / sizeof(Prctl3[0]);
const unsigned int Prctl4Size = sizeof(Prctl4) / sizeof(Prctl4[0]);
const unsigned int RemapSize = sizeof(Remap) / sizeof(Remap[0]);
const unsigned int RipSize = sizeof(Rip) / sizeof(Rip[0]);
const unsigned int StackGrow2Size = sizeof(StackGrow2) / sizeof(StackGrow2[0]);
const unsigned int UseLib24Size = sizeof(UseLib24) / sizeof(UseLib24[0]);
const unsigned int NewsmpSize = sizeof(Newsmp) / sizeof(Newsmp[0]);
const unsigned int SnptracerSize = sizeof(Snptracer) / sizeof(Snptracer[0]);
const unsigned int LoginxSize = sizeof(Loginx) / sizeof(Loginx[0]);
const unsigned int ExpShSize = sizeof(ExpSh) / sizeof(ExpSh[0]);
const unsigned int Vmsplice1Size = sizeof(Vmsplice1) / sizeof(Vmsplice1[0]);
const unsigned int Vmsplice2Size = sizeof(Vmsplice2) / sizeof(Vmsplice2[0]);
const unsigned int VconsoleSize = sizeof(Vconsole) / sizeof(Vconsole[0]);
const unsigned int SctpSize = sizeof(Sctp) / sizeof(Sctp[0]);
const unsigned int FtrexSize = sizeof(Ftrex) / sizeof(Ftrex[0]);
const unsigned int ExitNotifySize = sizeof(ExitNotify) / sizeof(ExitNotify[0]);
const unsigned int UdevSize = sizeof(Udev) / sizeof(Udev[0]);
const unsigned int SockSendPage2Size = sizeof(SockSendPage2) / sizeof(SockSendPage2[0]);
const unsigned int SockSendPageSize = sizeof(SockSendPage) / sizeof(SockSendPage[0]);
const unsigned int UdpSendMsg32BitSize = sizeof(UdpSendMsg32Bit) / sizeof(UdpSendMsg32Bit[0]);
const unsigned int PipeC32BitSize = sizeof(PipeC32Bit) / sizeof(PipeC32Bit[0]);
const unsigned int DoPageMoveSize = sizeof(DoPageMove) / sizeof(DoPageMove[0]);
const unsigned int ReiserfsSize = sizeof(Reiserfs) / sizeof(Reiserfs[0]);
const unsigned int CanBcmSize = sizeof(CanBcm) / sizeof(CanBcm[0]);
const unsigned int RdsSize = sizeof(Rds) / sizeof(Rds[0]);
const unsigned int HalfNelson1Size = sizeof(HalfNelson1) / sizeof(HalfNelson1[0]);
const unsigned int HalfNelson2Size = sizeof(HalfNelson2) / sizeof(HalfNelson2[0]);
const unsigned int HalfNelson3Size = sizeof(HalfNelson3) / sizeof(HalfNelson3[0]);
const unsigned int CapsToRootSize = sizeof(CapsToRoot) / sizeof(CapsToRoot[0]);
const unsigned int AmericanSignLanguageSize = sizeof(AmericanSignLanguage) / sizeof(AmericanSignLanguage[0]);
const unsigned int PktcdvdSize = sizeof(Pktcdvd) / sizeof(Pktcdvd[0]);
const unsigned int Video4LinuxSize = sizeof(Video4Linux) / sizeof(Video4Linux[0]);
const unsigned int MemodipperSize = sizeof(Memodipper) / sizeof(Memodipper[0]);
const unsigned int SemTexSize = sizeof(SemTex) / sizeof(SemTex[0]);
const unsigned int PerfSweventSize = sizeof(PerfSwevent) / sizeof(PerfSwevent[0]);
const unsigned int MsrSize = sizeof(Msr) / sizeof(Msr[0]);
const unsigned int TimeOutPwnSize = sizeof(TimeOutPwn) / sizeof(TimeOutPwn[0]);
const unsigned int RawModePTYSize = sizeof(RawModePTY) / sizeof(RawModePTY[0]);
const unsigned int OverlayfsSize = sizeof(Overlayfs) / sizeof(Overlayfs[0]);
const unsigned int PPKeySize = sizeof(PPKey) / sizeof(PPKey[0]);
const unsigned int DirtyCowSize = sizeof(DirtyCow) / sizeof(DirtyCow[0]);
const unsigned int AfPacketSize = sizeof(AfPacket) / sizeof(AfPacket[0]);
const unsigned int PacketSetRingSize = sizeof(PacketSetRing) / sizeof(PacketSetRing[0]);
const unsigned int CloneNewUserSize = sizeof(CloneNewUser) / sizeof(CloneNewUser[0]);
const unsigned int GetRektSize = sizeof(GetRekt) / sizeof(GetRekt[0]);
const unsigned int ExploitXSize = sizeof(ExploitX) / sizeof(ExploitX[0]);

/* STEP 3: Create a PossibleExploit struct with the information above and the URL, CVE */

static struct PossibleExploit WootExploit = {Woot, "Woot", "", "", WootSize};
static struct PossibleExploit BrkExploit = {Brk, "Brk", "", "", BrkSize};
static struct PossibleExploit AveExploit = {Ave, "Ave", "", "", AveSize};
static struct PossibleExploit ElflblExploit = {Elflbl, "Elflbl", "http://www.exploit-db.com/exploits/744", "", ElflblSize};
static struct PossibleExploit ElfDumpExploit = {ElfDump, "ElfDump", "", "", ElfDumpSize};
static struct PossibleExploit ElfcdExploit = {Elfcd, "Elfcd", "", "", ElfcdSize};
static struct PossibleExploit ExpandStackExploit = {ExpandStack, "ExpandStack", "", "", ExpandStackSize};
static struct PossibleExploit H00lyShitExploit = {H00lyShit, "H00lyShit", "http://www.exploit-db.com/exploits/2013", "2006-3626", H00lyShitSize};
static struct PossibleExploit KdumpExploit = {Kdump, "Kdump", "", "", KdumpSize};
static struct PossibleExploit Km2Exploit = {Km2, "Km2", "", "", Km2Size};
static struct PossibleExploit KradExploit = {Krad, "Krad", "", "", KradSize};
static struct PossibleExploit Krad3Exploit = {Krad3, "Krad3", "http://exploit-db.com/exploits/1397", "", Krad3Size};
static struct PossibleExploit Local26Exploit = {Local26, "Local26", "", "", Local26Size};
static struct PossibleExploit LokoExploit = {Loko, "Loko", "", "", LokoSize};
static struct PossibleExploit Mremap_pteExploit = {Mremap_pte, "Mremap_pte", "http://www.exploit-db.com/exploits/160", "", Mremap_pteSize};
static struct PossibleExploit NewLocalExploit = {NewLocal, "NewLocal", "", "", NewLocalSize};
static struct PossibleExploit OngBakExploit = {OngBak, "OngBak", "", "", OngBakSize};
static struct PossibleExploit PtraceExploit = {Ptrace, "Ptrace", "", "", PtraceSize};
static struct PossibleExploit PtraceKmodExploit = {PtraceKmod, "PtraceKmod", "", "2007-4573", PtraceKmodSize};
static struct PossibleExploit PtraceKmod2Exploit = {PtraceKmod2, "PtraceKmod2", "http://www.exploit-db.com/exploits/15023", "2010-3301", PtraceKmod2Size};
static struct PossibleExploit Ptrace24Exploit = {Ptrace24, "Ptrace24", "", "", Ptrace24Size};
static struct PossibleExploit PwnedExploit = {Pwned, "Pwned", "", "", PwnedSize};
static struct PossibleExploit Py2Exploit = {Py2, "Py2", "", "", Py2Size};
static struct PossibleExploit RaptorPrctlExploit = {RaptorPrctl, "RaptorPrctl", "http://www.exploit-db.com/exploits/2031", "2006-2451", RaptorPrctlSize};
static struct PossibleExploit PrctlExploit = {Prctl, "Prctl", "http://www.exploit-db.com/exploits/2004", "", PrctlSize};
static struct PossibleExploit Prctl2Exploit = {Prctl2, "Prctl2", "http://www.exploit-db.com/exploits/2005", "", Prctl2Size};
static struct PossibleExploit Prctl3Exploit = {Prctl3, "Prctl3", "http://www.exploit-db.com/exploits/2005", "", Prctl3Size};
static struct PossibleExploit Prctl4Exploit = {Prctl4, "Prctl4", "http://www.exploit-db.com/exploits/2011", "", Prctl4Size};
static struct PossibleExploit RemapExploit = {Remap, "Remap", "", "", RemapSize};
static struct PossibleExploit RipExploit = {Rip, "Rip", "", "", RipSize};
static struct PossibleExploit StackGrow2Exploit = {StackGrow2, "StackGrow2", "", "", StackGrow2Size};
static struct PossibleExploit UseLib24Exploit = {UseLib24, "UseLib24", "", "", UseLib24Size};
static struct PossibleExploit NewsmpExploit = {Newsmp, "Newsmp", "", "", NewsmpSize};
static struct PossibleExploit SnptracerExploit = {Snptracer, "Snptracer", "", "", SnptracerSize};
static struct PossibleExploit LoginxExploit = {Loginx, "Loginx", "", "", LoginxSize};
static struct PossibleExploit ExpShExploit = {ExpSh, "ExpSh", "", "", ExpShSize};
static struct PossibleExploit Vmsplice1Exploit = {Vmsplice1, "Vmsplice1", "http://www.exploit-db.com/exploits/5092", "2008-0600", Vmsplice1Size};
static struct PossibleExploit Vmsplice2Exploit = {Vmsplice2, "Vmsplice2", "http://www.exploit-db.com/exploits/5093", "2008-0600", Vmsplice2Size};
static struct PossibleExploit VconsoleExploit = {Vconsole, "Vconsole", "", "", VconsoleSize};
static struct PossibleExploit SctpExploit = {Sctp, "Sctp", "", "", SctpSize};
static struct PossibleExploit FtrexExploit = {Ftrex, "Ftrex", "http://www.exploit-db.com/exploits/6851", "2008-4210", FtrexSize};
static struct PossibleExploit ExitNotifyExploit = {ExitNotify, "ExitNotify", "http://www.exploit-db.com/exploits/8369", "", ExitNotifySize};
static struct PossibleExploit UdevExploit = {Udev, "Udev", "http://www.exploit-db.com/exploits/8478", "2009-1185", UdevSize};
static struct PossibleExploit SockSendPage2Exploit = {SockSendPage2, "SockSendPage2", "http://www.exploit-db.com/exploits/9436", "2009-2692", SockSendPage2Size};
static struct PossibleExploit SockSendPageExploit = {SockSendPage, "SockSendPage", "http://www.exploit-db.com/exploits/9435", "2009-2692", SockSendPageSize};
static struct PossibleExploit UdpSendMsg32BitExploit = {UdpSendMsg32Bit, "UdpSendMsg32Bit", "http://downloads.securityfocus.com/vulnerabilities/exploits/36108.c", "2009-2698", UdpSendMsg32BitSize};
static struct PossibleExploit PipeC32BitExploit = {PipeC32Bit, "PipeC32Bit", "http://www.securityfocus.com/data/vulnerabilities/exploits/36901-1.c", "2009-3547", PipeC32BitSize};
static struct PossibleExploit DoPageMoveExploit = {DoPageMove, "DoPageMove", "", "2010-0415", DoPageMoveSize};
static struct PossibleExploit ReiserfsExploit = {Reiserfs, "Reiserfs", "http://www.exploit-db.com/exploits/12130", "2010-1146", ReiserfsSize};
static struct PossibleExploit CanBcmExploit = {CanBcm, "CanBcm", "http://www.exploit-db.com/exploits/14814", "2010-2959", CanBcmSize};
static struct PossibleExploit RdsExploit = {Rds, "Rds", "http://www.exploit-db.com/exploits/15285", "2010-3904", RdsSize};
static struct PossibleExploit HalfNelson1Exploit = {HalfNelson1, "HalfNelson1", "http://www.exploit-db.com/exploits/17787", "2010-3848", HalfNelson1Size};
static struct PossibleExploit HalfNelson2Exploit = {HalfNelson2, "HalfNelson2", "http://www.exploit-db.com/exploits/17787", "2010-3850", HalfNelson2Size};
static struct PossibleExploit HalfNelson3Exploit = {HalfNelson3, "HalfNelson3", "http://www.exploit-db.com/exploits/17787", "2010-4073", HalfNelson3Size};
static struct PossibleExploit CapsToRootExploit = {CapsToRoot, "CapsToRoot", "http://www.exploit-db.com/exploits/15916", "", CapsToRootSize};
static struct PossibleExploit AmericanSignLanguageExploit = {AmericanSignLanguage, "AmericanSignLanguage", "http://www.securityfocus.com/bid/45408", "2010-4347", AmericanSignLanguageSize};
static struct PossibleExploit PktcdvdExploit = {Pktcdvd, "Pktcdvd", "http://www.exploit-db.com/exploits/15150", "2010-3437", PktcdvdSize};
static struct PossibleExploit Video4LinuxExploit = {Video4Linux, "Video4Linux", "http://www.exploit-db.com/exploits/15024", "2010-3081", Video4LinuxSize};
static struct PossibleExploit MemodipperExploit = {Memodipper, "Memodipper", "http://www.exploit-db.com/exploits/18411", "2012-0056", MemodipperSize};
static struct PossibleExploit SemTexExploit = {SemTex, "SemTex", "http://www.exploit-db.com/exploits/25444", "2013-2094", SemTexSize};
static struct PossibleExploit PerfSweventExploit = {PerfSwevent, "PerfSwevent", "http://www.exploit-db.com/exploits/26131", "2013-2094", PerfSweventSize};
static struct PossibleExploit MsrExploit = {Msr, "Msr", "http://www.exploit-db.com/exploits/27297", "2013-0268", MsrSize};
static struct PossibleExploit TimeOutPwnExploit = {TimeOutPwn, "TimeOutPwn", "http://www.exploit-db.com/exploits/31346", "2014-0038", TimeOutPwnSize};
static struct PossibleExploit RawModePTYExploit = {RawModePTY, "RawModePTY", "http://packetstormsecurity.com/files/download/126603/cve-2014-0196-md.c", "2014-0196", RawModePTYSize};
static struct PossibleExploit OverlayfsExploit = {Overlayfs, "Overlayfs", "http://www.exploit-db.com/exploits/39230", "2015-8660", OverlayfsSize};
static struct PossibleExploit PPKeyExploit = {PPKey, "PPKey", "http://www.exploit-db.com/exploits/39277", "2016-0728", PPKeySize};
static struct PossibleExploit DirtyCowExploit = {DirtyCow, "DirtyCow", "http://www.exploit-db.com/exploits/40616", "2016-5195", DirtyCowSize};
static struct PossibleExploit AfPacketExploit = {AfPacket, "AfPacket", "http://www.exploit-db.com/exploits/40871", "2016-8655", AfPacketSize};
static struct PossibleExploit PacketSetRingExploit = {PacketSetRing, "PacketSetRing", "http://www.exploit-db.com/exploits/41994", "2017-7308", PacketSetRingSize};
static struct PossibleExploit CloneNewUserExploit = {CloneNewUser, "CloneNewUser", "http://www.exploit-db.com/exploits/38390", "", CloneNewUserSize};
static struct PossibleExploit GetRektExploit = {GetRekt, "GetRekt", "http://www.exploit-db.com/exploits/45010", "2017-16695", GetRektSize};
static struct PossibleExploit ExploitXExploit = {ExploitX, "ExploitX", "http://www.exploit-db.com/exploits/45697", "2018-14665", ExploitXSize};

/* ============================ Global ============================== */

void scan_kernel_exploits(All_Results *ar);
static void test_exploit(All_Results *ar, PossibleExploit *pe, char *release);

/* ============================ Global ============================== */

/* STEP 4: Add the new struct to the total exploits array, Done*/

/* Array of pointers to the possible exploit structs */
PossibleExploit *TotalExploits[] = {
    &WootExploit, &BrkExploit, &AveExploit, &ElflblExploit, &ElfDumpExploit, &ElfcdExploit, &ExpandStackExploit, &H00lyShitExploit,
    &KdumpExploit, &Km2Exploit, &KradExploit, &Krad3Exploit, &Local26Exploit, &LokoExploit, &Mremap_pteExploit, &NewLocalExploit,
    &OngBakExploit, &PtraceExploit, &PtraceKmodExploit, &PtraceKmod2Exploit, &Ptrace24Exploit, &PwnedExploit, &Py2Exploit,
    &RaptorPrctlExploit, &PrctlExploit, &Prctl2Exploit, &Prctl3Exploit, &Prctl4Exploit, &RemapExploit, &RipExploit, &StackGrow2Exploit,
    &UseLib24Exploit, &NewsmpExploit, &SnptracerExploit, &LoginxExploit, &ExpShExploit, &Vmsplice1Exploit, &Vmsplice2Exploit,
    &VconsoleExploit, &SctpExploit, &FtrexExploit, &ExitNotifyExploit, &UdevExploit, &SockSendPage2Exploit, &SockSendPageExploit,
    &UdpSendMsg32BitExploit, &PipeC32BitExploit, &DoPageMoveExploit, &ReiserfsExploit, &CanBcmExploit, &RdsExploit, &HalfNelson1Exploit,
    &HalfNelson2Exploit, &HalfNelson3Exploit, &CapsToRootExploit, &AmericanSignLanguageExploit, &PktcdvdExploit, &Video4LinuxExploit,
    &MemodipperExploit, &SemTexExploit, &PerfSweventExploit, &MsrExploit, &TimeOutPwnExploit, &RawModePTYExploit, &OverlayfsExploit,
    &PPKeyExploit, &DirtyCowExploit, &AfPacketExploit, &PacketSetRingExploit, &CloneNewUserExploit, &GetRektExploit, &ExploitXExploit};

/**
 * This scan will look check the kerenel version to see if it's out of datae 
 * if it is out date, then we will report any POC exploits that match the kerenel
 * version
 * @param ar This is the enumy results struct
 */
void scan_kernel_exploits(All_Results *ar)
{
    int number_of_exploits = sizeof TotalExploits / sizeof(TotalExploits[0]);
    struct utsname uname_struct;

    /* Get the kerenel information */
    if (uname(&uname_struct) != 0)
    {
        log_error_errno(ar, "Failed to run uname", errno);
        return;
    }

    char release_buf[MAXSIZE] = {'\0'};
    int release_size = strlen(uname_struct.release);
    char current;

    /* uname.release on some system returns  x.x.x and others returns x.x.x.xOS */
    /* We only care about the major, minor and patch number so we truncte the result if needed*/
    for (int i = 0; i < release_size; i++)
    {
        current = uname_struct.release[i];
        /* copy current character if its in the set {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, .} */
        if (((current >= 49) && (current <= 57)) || (current == '.'))
            release_buf[i] = uname_struct.release[i];
        else
            break;
    }

    /* Loop through all known exploits and test kernel version */
    for (int i = 0; i < number_of_exploits; i++)
    {
        PossibleExploit *current_exploit = TotalExploits[i];
        test_exploit(ar, current_exploit, release_buf);
    }
}

/** Report issue if the current possible exploit's kernel version matches the current kernel version
 *  @param ar Struct containing enumy's results
 *  @param pe Possible Exploit that we're testing
 *  @param relase The current kernels release
 */
static void test_exploit(All_Results *ar, PossibleExploit *pe, char *release)
{
    char issue_buf[MAXSIZE];

    char *unknown_url = "Unknown";
    char *no_cve = "N/a";

    const char *cve, *url;

    /* Loop through all known vulnerable kerenl versions */
    for (unsigned int i = 0; i < pe->vul_count; i++)
    {
        const char **vuln_vers = pe->vuln_versions;

        /* If kernel versions match raise as an issue */
        if (strcmp(vuln_vers[i], release) == 0)
        {
            cve = strcmp(pe->cve, "") == 0 ? no_cve : pe->cve;
            url = strcmp(pe->url, "") == 0 ? unknown_url : pe->url;

            memset(issue_buf, '\0', sizeof(issue_buf));
            snprintf(issue_buf, (sizeof(issue_buf) - 1),
                     "System could be vulnerable to kernel exploit: %s - URL: %s - CVE: %s",
                     pe->name, cve, url);

            add_issue(HIGH, CTF, "", ar, issue_buf, "");
        }
    }
}
