/*
    This file will use uname to get the kernel version and OS. Based off this information we 
    can surgest possible POC exploits 

    Follow the steps in the comments to add an exploit
*/

#include <errno.h>
#include <stdio.h>
#include <string.h>
#include <sys/utsname.h>

#include "debug.h"
#include "error_logger.h"
#include "file_system.h"
#include "main.h"
#include "results.h"

/* ============================ STRUCTS ============================== */

/* Stuct for a single exploit */
typedef struct PossibleExploit
{
    const char **vuln_versions;   /* Array of known vulnerablie kernel versions */
    const char *name;             /* Name of the vulnerability */
    const char *cve;              /* The CVE for the vulnerability if it has one */
    const char *url;              /* The URL to the POC exploit if it has one */
    const unsigned int vul_count; /* Size of vuln_versions */
} PossibleExploit;

/* ============================ CONSTS ============================== */

/* Below is a bunch of hardcoded set of vulnerable kernel versions that relate to a single exploit */
/* STEP 1: create a const char *[] of known vulnerable kerenel versions */

const char *Woot[] = {"2.4.10", "2.4.16", "2.4.17", "2.4.18", "2.4.19", "2.4.20", "2.4.21"};
const char *Brk[] = {"2.4.10", "2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22"};
const char *Ave[] = {"2.4.19", "2.4.20"};
const char *Elflbl[] = {"2.4.29"};
const char *ElfDump[] = {"2.4.27"};
const char *Elfcd[] = {"2.6.12"};
const char *ExpandStack[] = {"2.4.29"};
const char *H00lyShit[] = {"2.6.8", "2.6.10", "2.6.11", "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16"};
const char *Kdump[] = {"2.6.13"};
const char *Km2Pwn[] = {"2.4.18", "2.4.22"};
const char *Krad[] = {"2.6.5", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11"};
const char *Krad3[] = {"2.6.5", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11"};
const char *Local26[] = {"2.6.13"};
const char *Loko[] = {"2.4.22", "2.4.23", "2.4.24"};
const char *Mremap_pte[] = {"2.4.20", "2.2.24", "2.4.25", "2.4.26", "2.4.27"};
const char *NewLocal[] = {"2.4.17", "2.4.19"};
const char *OngBak[] = {"2.6.5"};
const char *Ptrace[] = {"2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22"};
const char *PtraceKmod[] = {"2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22"};
const char *PtraceKmod2[] = {"2.6.26", "2.6.27", "2.6.28", "2.6.29", "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34"};
const char *Ptrace24[] = {"2.4.9"};
const char *Pwned[] = {"2.6.11"};
const char *Py2Pwn[] = {"2.6.9", "2.6.17", "2.6.15", "2.6.13"};
const char *RaptorPrctl[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Prctl[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Prctl2[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Prctl3[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Prctl4[] = {"2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17"};
const char *Remap[] = {"2.4"};
const char *RipPwn[] = {"2.2"};
const char *StackGrow2[] = {"2.4.29", "2.6.10"};
const char *UseLib24[] = {"2.6.10", "2.4.17", "2.4.22", "2.4.25", "2.4.27", "2.4.29"};
const char *Newsmp[] = {"2.6"};
const char *Snptracer[] = {"2.4.29"};
const char *Loginx[] = {"2.4.22"};
const char *ExpSh[] = {"2.6.9", "2.6.10", "2.6.16", "2.6.13"};
const char *Vmsplice1[] = {"2.6.17", "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23", "2.6.24", "2.6.24.1"};
const char *Vmsplice2[] = {"2.6.23", "2.6.24"};
const char *Vconsole[] = {"2.6"};
const char *Sctp[] = {"2.6.26"};

const char *Ftrex[] = {"2.6.11", "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17", "2.6.18", "2.6.19",
                       "2.6.20", "2.6.21", "2.6.22"};

const char *ExitNotify[] = {"2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29"};
const char *Udev[] = {"2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29"};

const char *SockSendPage2[] = {"2.4.4", "2.4.5", "2.4.6", "2.4.7", "2.4.8", "2.4.9", "2.4.10", "2.4.11", "2.4.12",
                               "2.4.13", "2.4.14", "2.4.15", "2.4.16", "2.4.17", "2.4.18", "2.4.19", "2.4.20", "2.4.21",
                               "2.4.22", "2.4.23", "2.4.24", "2.4.25", "2.4.26", "2.4.27", "2.4.28", "2.4.29", "2.4.30",
                               "2.4.31", "2.4.32", "2.4.33", "2.4.34", "2.4.35", "2.4.36", "2.4.37", "2.6.0", "2.6.1",
                               "2.6.2", "2.6.3", "2.6.4", "2.6.5", "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                               "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17", "2.6.18", "2.6.19", "2.6.20",
                               "2.6.21", "2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29", "2.6.30"};

const char *SockSendPage[] = {"2.4.4", "2.4.5", "2.4.6", "2.4.7", "2.4.8", "2.4.9", "2.4.10", "2.4.11", "2.4.12", "2.4.13",
                              "2.4.14", "2.4.15", "2.4.16", "2.4.17", "2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22", "2.4.23",
                              "2.4.24", "2.4.25", "2.4.26", "2.4.27", "2.4.28", "2.4.29", "2.4.30", "2.4.31", "2.4.32", "2.4.33",
                              "2.4.34", "2.4.35", "2.4.36", "2.4.37", "2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5", "2.6.6",
                              "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11", "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16",
                              "2.6.17", "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26",
                              "2.6.27", "2.6.28", "2.6.29", "2.6.30"};

const char *UdpSendMsg32Bit[] = {"2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5", "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                                 "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17", "2.6.18", "2.6.19"};

const char *PipeC32Bit[] = {"2.4.4", "2.4.5", "2.4.6", "2.4.7", "2.4.8", "2.4.9", "2.4.10", "2.4.11", "2.4.12", "2.4.13", "2.4.14",
                            "2.4.15", "2.4.16", "2.4.17", "2.4.18", "2.4.19", "2.4.20", "2.4.21", "2.4.22", "2.4.23", "2.4.24",
                            "2.4.25", "2.4.26", "2.4.27", "2.4.28", "2.4.29", "2.4.30", "2.4.31", "2.4.32", "2.4.33", "2.4.34",
                            "2.4.35", "2.4.36", "2.4.37", "2.6.15", "2.6.16", "2.6.17", "2.6.18", "2.6.19", "2.6.20", "2.6.21",
                            "2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29", "2.6.30", "2.6.31"};

const char *DoPageMove[] = {"2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27",
                            "2.6.28", "2.6.29", "2.6.30", "2.6.31"};

const char *Reiserfs[] = {"2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                          "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                          "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34"};

const char *CanBcm[] = {"2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                        "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                        "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                        "2.6.36"};

const char *RdsPwn[] = {"2.6.30", "2.6.31", "2.6.32", "2.6.33",
                        "2.6.34", "2.6.35", "2.6.36"};

const char *HalfNelson1[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                             "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                             "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                             "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                             "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                             "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                             "2.6.36"};

const char *HalfNelson2[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                             "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                             "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                             "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                             "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                             "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                             "2.6.36"};
const char *HalfNelson3[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                             "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                             "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                             "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                             "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                             "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                             "2.6.36"};
const char *CapsToRoot[] = {"2.6.34", "2.6.35", "2.6.36"};

const char *AmericanSignLanguage[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                                      "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                                      "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                                      "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                                      "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                                      "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                                      "2.6.36"};

const char *Pktcdvd[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                         "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                         "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                         "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                         "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                         "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35",
                         "2.6.36"};

const char *Video4Linux[] = {"2.6.0", "2.6.1", "2.6.2", "2.6.3", "2.6.4", "2.6.5",
                             "2.6.6", "2.6.7", "2.6.8", "2.6.9", "2.6.10", "2.6.11",
                             "2.6.12", "2.6.13", "2.6.14", "2.6.15", "2.6.16", "2.6.17",
                             "2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                             "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.28", "2.6.29",
                             "2.6.30", "2.6.31", "2.6.32", "2.6.33"};

const char *Memodipper[] = {"2.6.39", "3.0.0", "3.0.1", "3.0.2", "3.0.3", "3.0.4",
                            "3.0.5", "3.0.6", "3.1.0"};

const char *SemTex[] = {"2.6.37", "2.6.38", "2.6.39", "3.0.0", "3.0.1", "3.0.2",
                        "3.0.3", "3.0.4", "3.0.5", "3.0.6", "3.1.0"};

const char *PerfSwevent[] = {"3.0.0", "3.0.1", "3.0.2", "3.0.3", "3.0.4", "3.0.5",
                             "3.0.6", "3.1.0", "3.2.0", "3.3.0", "3.4.0", "3.4.1",
                             "3.4.2", "3.4.3", "3.4.4", "3.4.5", "3.4.6", "3.4.8",
                             "3.4.9", "3.5.0", "3.6.0", "3.7.0", "3.8.0", "3.8.1",
                             "3.8.2", "3.8.3", "3.8.4", "3.8.5", "3.8.6", "3.8.7",
                             "3.8.8", "3.8.9"};

const char *MsrPwn[] = {"2.6.18", "2.6.19", "2.6.20", "2.6.21", "2.6.22", "2.6.23",
                        "2.6.24", "2.6.25", "2.6.26", "2.6.27", "2.6.27", "2.6.28",
                        "2.6.29", "2.6.30", "2.6.31", "2.6.32", "2.6.33", "2.6.34",
                        "2.6.35", "2.6.36", "2.6.37", "2.6.38", "2.6.39", "3.0.0",
                        "3.0.1", "3.0.2", "3.0.3", "3.0.4", "3.0.5", "3.0.6",
                        "3.1.0", "3.2.0", "3.3.0", "3.4.0", "3.5.0", "3.6.0",
                        "3.7.0", "3.7.6"};

const char *TimeOutPwn[] = {"3.4.0", "3.5.0", "3.6.0", "3.7.0", "3.8.0", "3.8.9",
                            "3.9.0", "3.10.0", "3.11.0", "3.12.0", "3.13.0", "3.4.0",
                            "3.5.0", "3.6.0", "3.7.0", "3.8.0", "3.8.5", "3.8.6",
                            "3.8.9", "3.9.0", "3.9.6", "3.10.0", "3.10.6", "3.11.0",
                            "3.12.0", "3.13.0", "3.13.1"};

const char *RawModePTY[] = {"2.6.31", "2.6.32", "2.6.33", "2.6.34", "2.6.35", "2.6.36",
                            "2.6.37", "2.6.38", "2.6.39", "3.14.0", "3.15.0"};

const char *Overlayfs[] = {"3.13.0", "3.16.0", "3.19.0"};

const char *PPKey[] = {"3.4.0", "3.5.0", "3.6.0", "3.7.0", "3.8.0", "3.8.1",
                       "3.8.2", "3.8.3", "3.8.4", "3.8.5", "3.8.6", "3.8.7",
                       "3.8.8", "3.8.9", "3.9.0", "3.9.6", "3.10.0", "3.10.6",
                       "3.11.0", "3.12.0", "3.13.0", "3.13.1"};

const char *DirtyCow[] = {"2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27",
                          "2.6.27", "2.6.28", "2.6.29", "2.6.30", "2.6.31", "2.6.32",
                          "2.6.33", "2.6.34", "2.6.35", "2.6.36", "2.6.37", "2.6.38",
                          "2.6.39", "3.0.0", "3.0.1", "3.0.2", "3.0.3", "3.0.4",
                          "3.0.5", "3.0.6", "3.1.0", "3.2.0", "3.3.0", "3.4.0",
                          "3.5.0", "3.6.0", "3.7.0", "3.7.6", "3.8.0", "3.9.0",
                          "3.10.0", "3.11.0", "3.12.0", "3.13.0", "3.14.0", "3.15.0",
                          "3.16.0", "3.17.0", "3.18.0", "3.19.0", "4.0.0", "4.1.0",
                          "4.2.0", "4.3.0", "4.4.0", "4.5.0", "4.6.0", "4.7.0"};

const char *AfPacket[] = {"4.4.0"};
const char *PacketSetRing[] = {"4.8.0"};

const char *CloneNewUser[] = {"3.3.5", "3.3.4", "3.3.2", "3.2.13", "3.2.9", "3.2.1",
                              "3.1.8", "3.0.5", "3.0.4", "3.0.2", "3.0.1", "3.2", "3.0.1", "3.0"};

const char *GetRekt[] = {"4.4.0", "4.8.0", "4.10.0", "4.13.0"};
const char *ExploitX[] = {"2.6.22", "2.6.23", "2.6.24", "2.6.25", "2.6.26", "2.6.27",
                          "2.6.27", "2.6.28", "2.6.29", "2.6.30", "2.6.31", "2.6.32",
                          "2.6.33", "2.6.34", "2.6.35", "2.6.36", "2.6.37", "2.6.38",
                          "2.6.39", "3.0.0", "3.0.1", "3.0.2", "3.0.3", "3.0.4",
                          "3.0.5", "3.0.6", "3.1.0", "3.2.0", "3.3.0", "3.4.0",
                          "3.5.0", "3.6.0", "3.7.0", "3.7.6", "3.8.0", "3.9.0",
                          "3.10.0", "3.11.0", "3.12.0", "3.13.0", "3.14.0", "3.15.0",
                          "3.16.0", "3.17.0", "3.18.0", "3.19.0", "4.0.0", "4.1.0",
                          "4.2.0", "4.3.0", "4.4.0", "4.5.0", "4.6.0", "4.7.0"};

/* ============================ Static Structs ============================== */

/* STEP 2: Calculate the number of effected kernel versions for each exploit */

#define WOOTSIZE sizeof(Woot) / sizeof(Woot[0])
#define BRKSIZE sizeof(Brk) / sizeof(Brk[0])
#define AVESIZE sizeof(Ave) / sizeof(Ave[0])
#define ELFLBLSIZE sizeof(Elflbl) / sizeof(Elflbl[0])
#define ELFDUMPSIZE sizeof(ElfDump) / sizeof(ElfDump[0])
#define ELFCDSIZE sizeof(Elfcd) / sizeof(Elfcd[0])
#define EXPANDSTACKSIZE sizeof(ExpandStack) / sizeof(ExpandStack[0])
#define H00LYSHITSIZE sizeof(H00lyShit) / sizeof(H00lyShit[0])
#define KDUMPSIZE sizeof(Kdump) / sizeof(Kdump[0])
#define KM2PWNSIZE sizeof(Km2Pwn) / sizeof(Km2Pwn[0])
#define KRADSIZE sizeof(Krad) / sizeof(Krad[0])
#define KRAD3SIZE sizeof(Krad3) / sizeof(Krad3[0])
#define LOCAL26SIZE sizeof(Local26) / sizeof(Local26[0])
#define LOKOSIZE sizeof(Loko) / sizeof(Loko[0])
#define MREMAP_PTESIZE sizeof(Mremap_pte) / sizeof(Mremap_pte[0])
#define NEWLOCALSIZE sizeof(NewLocal) / sizeof(NewLocal[0])
#define ONGBAKSIZE sizeof(OngBak) / sizeof(OngBak[0])
#define PTRACESIZE sizeof(Ptrace) / sizeof(Ptrace[0])
#define PTRACEKMODSIZE sizeof(PtraceKmod) / sizeof(PtraceKmod[0])
#define PTRACEKMOD2SIZE sizeof(PtraceKmod2) / sizeof(PtraceKmod2[0])
#define PTRACE24SIZE sizeof(Ptrace24) / sizeof(Ptrace24[0])
#define PWNEDSIZE sizeof(Pwned) / sizeof(Pwned[0])
#define PY2PWNSIZE sizeof(Py2Pwn) / sizeof(Py2Pwn[0])
#define RAPTORPRCTLSIZE sizeof(RaptorPrctl) / sizeof(RaptorPrctl[0])
#define PRCTLSIZE sizeof(Prctl) / sizeof(Prctl[0])
#define PRCTL2SIZE sizeof(Prctl2) / sizeof(Prctl2[0])
#define PRCTL3SIZE sizeof(Prctl3) / sizeof(Prctl3[0])
#define PRCTL4SIZE sizeof(Prctl4) / sizeof(Prctl4[0])
#define REMAPSIZE sizeof(Remap) / sizeof(Remap[0])
#define RIPPWNSIZE sizeof(RipPwn) / sizeof(RipPwn[0])
#define STACKGROW2SIZE sizeof(StackGrow2) / sizeof(StackGrow2[0])
#define USELIB24SIZE sizeof(UseLib24) / sizeof(UseLib24[0])
#define NEWSMPSIZE sizeof(Newsmp) / sizeof(Newsmp[0])
#define SNPTRACERSIZE sizeof(Snptracer) / sizeof(Snptracer[0])
#define LOGINXSIZE sizeof(Loginx) / sizeof(Loginx[0])
#define EXPSHSIZE sizeof(ExpSh) / sizeof(ExpSh[0])
#define VMSPLICE1SIZE sizeof(Vmsplice1) / sizeof(Vmsplice1[0])
#define VMSPLICE2SIZE sizeof(Vmsplice2) / sizeof(Vmsplice2[0])
#define VCONSOLESIZE sizeof(Vconsole) / sizeof(Vconsole[0])
#define SCTPSIZE sizeof(Sctp) / sizeof(Sctp[0])
#define FTREXSIZE sizeof(Ftrex) / sizeof(Ftrex[0])
#define EXITNOTIFYSIZE sizeof(ExitNotify) / sizeof(ExitNotify[0])
#define UDEVSIZE sizeof(Udev) / sizeof(Udev[0])
#define SOCKSENDPAGE2SIZE sizeof(SockSendPage2) / sizeof(SockSendPage2[0])
#define SOCKSENDPAGESIZE sizeof(SockSendPage) / sizeof(SockSendPage[0])
#define UDPSENDMSG32BITSIZE sizeof(UdpSendMsg32Bit) / sizeof(UdpSendMsg32Bit[0])
#define PIPEC32BITSIZE sizeof(PipeC32Bit) / sizeof(PipeC32Bit[0])
#define DOPAGEMOVESIZE sizeof(DoPageMove) / sizeof(DoPageMove[0])
#define REISERFSSIZE sizeof(Reiserfs) / sizeof(Reiserfs[0])
#define CANBCMSIZE sizeof(CanBcm) / sizeof(CanBcm[0])
#define RDSPWNSIZE sizeof(RdsPwn) / sizeof(RdsPwn[0])
#define HALFNELSON1SIZE sizeof(HalfNelson1) / sizeof(HalfNelson1[0])
#define HALFNELSON2SIZE sizeof(HalfNelson2) / sizeof(HalfNelson2[0])
#define HALFNELSON3SIZE sizeof(HalfNelson3) / sizeof(HalfNelson3[0])
#define CAPSTOROOTSIZE sizeof(CapsToRoot) / sizeof(CapsToRoot[0])
#define AMERICANSIGNLANGUAGESIZE sizeof(AmericanSignLanguage) / sizeof(AmericanSignLanguage[0])
#define PKTCDVDSIZE sizeof(Pktcdvd) / sizeof(Pktcdvd[0])
#define VIDEO4LINUXSIZE sizeof(Video4Linux) / sizeof(Video4Linux[0])
#define MEMODIPPERSIZE sizeof(Memodipper) / sizeof(Memodipper[0])
#define SEMTEXSIZE sizeof(SemTex) / sizeof(SemTex[0])
#define PERFSWEVENTSIZE sizeof(PerfSwevent) / sizeof(PerfSwevent[0])
#define MSRPWNSIZE sizeof(MsrPwn) / sizeof(MsrPwn[0])
#define TIMEOUTPWNSIZE sizeof(TimeOutPwn) / sizeof(TimeOutPwn[0])
#define RAWMODEPTYSIZE sizeof(RawModePTY) / sizeof(RawModePTY[0])
#define OVERLAYFSSIZE sizeof(Overlayfs) / sizeof(Overlayfs[0])
#define PPKEYSIZE sizeof(PPKey) / sizeof(PPKey[0])
#define DIRTYCOWSIZE sizeof(DirtyCow) / sizeof(DirtyCow[0])
#define AFPACKETSIZE sizeof(AfPacket) / sizeof(AfPacket[0])
#define PACKETSETRINGSIZE sizeof(PacketSetRing) / sizeof(PacketSetRing[0])
#define CLONENEWUSERSIZE sizeof(CloneNewUser) / sizeof(CloneNewUser[0])
#define GETREKTSIZE sizeof(GetRekt) / sizeof(GetRekt[0])
#define EXPLOITXSIZE sizeof(ExploitX) / sizeof(ExploitX[0])

/* STEP 3: Create a PossibleExploit struct with the information above and the URL, CVE */

static struct PossibleExploit WootExploit = {Woot, "Woot", "", "", WOOTSIZE};
static struct PossibleExploit BrkExploit = {Brk, "Brk", "", "", BRKSIZE};
static struct PossibleExploit AveExploit = {Ave, "Ave", "", "", AVESIZE};
static struct PossibleExploit ElflblExploit = {Elflbl, "Elflbl", "http://www.exploit-db.com/exploits/744", "", ELFLBLSIZE};
static struct PossibleExploit ElfDumpExploit = {ElfDump, "ElfDump", "", "", ELFDUMPSIZE};
static struct PossibleExploit ElfcdExploit = {Elfcd, "Elfcd", "", "", ELFCDSIZE};
static struct PossibleExploit ExpandStackExploit = {ExpandStack, "ExpandStack", "", "", EXPANDSTACKSIZE};
static struct PossibleExploit H00lyShitExploit = {H00lyShit, "H00lyShit", "http://www.exploit-db.com/exploits/2013", "2006-3626", H00LYSHITSIZE};
static struct PossibleExploit KdumpExploit = {Kdump, "Kdump", "", "", KDUMPSIZE};
static struct PossibleExploit Km2PwnExploit = {Km2Pwn, "Km2Pwn", "", "", KM2PWNSIZE};
static struct PossibleExploit KradExploit = {Krad, "Krad", "", "", KRADSIZE};
static struct PossibleExploit Krad3Exploit = {Krad3, "Krad3", "http://exploit-db.com/exploits/1397", "", KRAD3SIZE};
static struct PossibleExploit Local26Exploit = {Local26, "Local26", "", "", LOCAL26SIZE};
static struct PossibleExploit LokoExploit = {Loko, "Loko", "", "", LOKOSIZE};
static struct PossibleExploit Mremap_pteExploit = {Mremap_pte, "Mremap_pte", "http://www.exploit-db.com/exploits/160", "", MREMAP_PTESIZE};
static struct PossibleExploit NewLocalExploit = {NewLocal, "NewLocal", "", "", NEWLOCALSIZE};
static struct PossibleExploit OngBakExploit = {OngBak, "OngBak", "", "", ONGBAKSIZE};
static struct PossibleExploit PtraceExploit = {Ptrace, "Ptrace", "", "", PTRACESIZE};
static struct PossibleExploit PtraceKmodExploit = {PtraceKmod, "PtraceKmod", "", "2007-4573", PTRACEKMODSIZE};
static struct PossibleExploit PtraceKmod2Exploit = {PtraceKmod2, "PtraceKmod2", "http://www.exploit-db.com/exploits/15023", "2010-3301", PTRACEKMOD2SIZE};
static struct PossibleExploit Ptrace24Exploit = {Ptrace24, "Ptrace24", "", "", PTRACE24SIZE};
static struct PossibleExploit PwnedExploit = {Pwned, "Pwned", "", "", PWNEDSIZE};
static struct PossibleExploit Py2PwnExploit = {Py2Pwn, "Py2Pwn", "", "", PY2PWNSIZE};
static struct PossibleExploit RaptorPrctlExploit = {RaptorPrctl, "RaptorPrctl", "http://www.exploit-db.com/exploits/2031", "2006-2451", RAPTORPRCTLSIZE};
static struct PossibleExploit PrctlExploit = {Prctl, "Prctl", "http://www.exploit-db.com/exploits/2004", "", PRCTLSIZE};
static struct PossibleExploit Prctl2Exploit = {Prctl2, "Prctl2", "http://www.exploit-db.com/exploits/2005", "", PRCTL2SIZE};
static struct PossibleExploit Prctl3Exploit = {Prctl3, "Prctl3", "http://www.exploit-db.com/exploits/2005", "", PRCTL3SIZE};
static struct PossibleExploit Prctl4Exploit = {Prctl4, "Prctl4", "http://www.exploit-db.com/exploits/2011", "", PRCTL4SIZE};
static struct PossibleExploit RemapExploit = {Remap, "Remap", "", "", REMAPSIZE};
static struct PossibleExploit RipPwnExploit = {RipPwn, "RipPwn", "", "", RIPPWNSIZE};
static struct PossibleExploit StackGrow2Exploit = {StackGrow2, "StackGrow2", "", "", STACKGROW2SIZE};
static struct PossibleExploit UseLib24Exploit = {UseLib24, "UseLib24", "", "", USELIB24SIZE};
static struct PossibleExploit NewsmpExploit = {Newsmp, "Newsmp", "", "", NEWSMPSIZE};
static struct PossibleExploit SnptracerExploit = {Snptracer, "Snptracer", "", "", SNPTRACERSIZE};
static struct PossibleExploit LoginxExploit = {Loginx, "Loginx", "", "", LOGINXSIZE};
static struct PossibleExploit ExpShExploit = {ExpSh, "ExpSh", "", "", EXPSHSIZE};
static struct PossibleExploit Vmsplice1Exploit = {Vmsplice1, "Vmsplice1", "http://www.exploit-db.com/exploits/5092", "2008-0600", VMSPLICE1SIZE};
static struct PossibleExploit Vmsplice2Exploit = {Vmsplice2, "Vmsplice2", "http://www.exploit-db.com/exploits/5093", "2008-0600", VMSPLICE2SIZE};
static struct PossibleExploit VconsoleExploit = {Vconsole, "Vconsole", "", "", VCONSOLESIZE};
static struct PossibleExploit SctpExploit = {Sctp, "Sctp", "", "", SCTPSIZE};
static struct PossibleExploit FtrexExploit = {Ftrex, "Ftrex", "http://www.exploit-db.com/exploits/6851", "2008-4210", FTREXSIZE};
static struct PossibleExploit ExitNotifyExploit = {ExitNotify, "ExitNotify", "http://www.exploit-db.com/exploits/8369", "", EXITNOTIFYSIZE};
static struct PossibleExploit UdevExploit = {Udev, "Udev", "http://www.exploit-db.com/exploits/8478", "2009-1185", UDEVSIZE};
static struct PossibleExploit SockSendPage2Exploit = {SockSendPage2, "SockSendPage2", "http://www.exploit-db.com/exploits/9436", "2009-2692", SOCKSENDPAGE2SIZE};
static struct PossibleExploit SockSendPageExploit = {SockSendPage, "SockSendPage", "http://www.exploit-db.com/exploits/9435", "2009-2692", SOCKSENDPAGESIZE};
static struct PossibleExploit UdpSendMsg32BitExploit = {UdpSendMsg32Bit, "UdpSendMsg32Bit", "http://downloads.securityfocus.com/vulnerabilities/exploits/36108.c", "2009-2698", UDPSENDMSG32BITSIZE};
static struct PossibleExploit PipeC32BitExploit = {PipeC32Bit, "PipeC32Bit", "http://www.securityfocus.com/data/vulnerabilities/exploits/36901-1.c", "2009-3547", PIPEC32BITSIZE};
static struct PossibleExploit DoPageMoveExploit = {DoPageMove, "DoPageMove", "", "2010-0415", DOPAGEMOVESIZE};
static struct PossibleExploit ReiserfsExploit = {Reiserfs, "Reiserfs", "http://www.exploit-db.com/exploits/12130", "2010-1146", REISERFSSIZE};
static struct PossibleExploit CanBcmExploit = {CanBcm, "CanBcm", "http://www.exploit-db.com/exploits/14814", "2010-2959", CANBCMSIZE};
static struct PossibleExploit RdsPwnExploit = {RdsPwn, "RdsPwn", "http://www.exploit-db.com/exploits/15285", "2010-3904", RDSPWNSIZE};
static struct PossibleExploit HalfNelson1Exploit = {HalfNelson1, "HalfNelson1", "http://www.exploit-db.com/exploits/17787", "2010-3848", HALFNELSON1SIZE};
static struct PossibleExploit HalfNelson2Exploit = {HalfNelson2, "HalfNelson2", "http://www.exploit-db.com/exploits/17787", "2010-3850", HALFNELSON2SIZE};
static struct PossibleExploit HalfNelson3Exploit = {HalfNelson3, "HalfNelson3", "http://www.exploit-db.com/exploits/17787", "2010-4073", HALFNELSON3SIZE};
static struct PossibleExploit CapsToRootExploit = {CapsToRoot, "CapsToRoot", "http://www.exploit-db.com/exploits/15916", "", CAPSTOROOTSIZE};
static struct PossibleExploit AmericanSignLanguageExploit = {AmericanSignLanguage, "AmericanSignLanguage", "http://www.securityfocus.com/bid/45408", "2010-4347", AMERICANSIGNLANGUAGESIZE};
static struct PossibleExploit PktcdvdExploit = {Pktcdvd, "Pktcdvd", "http://www.exploit-db.com/exploits/15150", "2010-3437", PKTCDVDSIZE};
static struct PossibleExploit Video4LinuxExploit = {Video4Linux, "Video4Linux", "http://www.exploit-db.com/exploits/15024", "2010-3081", VIDEO4LINUXSIZE};
static struct PossibleExploit MemodipperExploit = {Memodipper, "Memodipper", "http://www.exploit-db.com/exploits/18411", "2012-0056", MEMODIPPERSIZE};
static struct PossibleExploit SemTexExploit = {SemTex, "SemTex", "http://www.exploit-db.com/exploits/25444", "2013-2094", SEMTEXSIZE};
static struct PossibleExploit PerfSweventExploit = {PerfSwevent, "PerfSwevent", "http://www.exploit-db.com/exploits/26131", "2013-2094", PERFSWEVENTSIZE};
static struct PossibleExploit MsrPwnExploit = {MsrPwn, "MsrPwn", "http://www.exploit-db.com/exploits/27297", "2013-0268", MSRPWNSIZE};
static struct PossibleExploit TimeOutPwnExploit = {TimeOutPwn, "TimeOutPwn", "http://www.exploit-db.com/exploits/31346", "2014-0038", TIMEOUTPWNSIZE};
static struct PossibleExploit RawModePTYExploit = {RawModePTY, "RawModePTY", "http://packetstormsecurity.com/files/download/126603/cve-2014-0196-md.c", "2014-0196", RAWMODEPTYSIZE};
static struct PossibleExploit OverlayfsExploit = {Overlayfs, "Overlayfs", "http://www.exploit-db.com/exploits/39230", "2015-8660", OVERLAYFSSIZE};
static struct PossibleExploit PPKeyExploit = {PPKey, "PPKey", "http://www.exploit-db.com/exploits/39277", "2016-0728", PPKEYSIZE};
static struct PossibleExploit DirtyCowExploit = {DirtyCow, "DirtyCow", "http://www.exploit-db.com/exploits/40616", "2016-5195", DIRTYCOWSIZE};
static struct PossibleExploit AfPacketExploit = {AfPacket, "AfPacket", "http://www.exploit-db.com/exploits/40871", "2016-8655", AFPACKETSIZE};
static struct PossibleExploit PacketSetRingExploit = {PacketSetRing, "PacketSetRing", "http://www.exploit-db.com/exploits/41994", "2017-7308", PACKETSETRINGSIZE};
static struct PossibleExploit CloneNewUserExploit = {CloneNewUser, "CloneNewUser", "http://www.exploit-db.com/exploits/38390", "", CLONENEWUSERSIZE};
static struct PossibleExploit GetRektExploit = {GetRekt, "GetRekt", "http://www.exploit-db.com/exploits/45010", "2017-16695", GETREKTSIZE};
static struct PossibleExploit ExploitXExploit = {ExploitX, "ExploitX", "http://www.exploit-db.com/exploits/45697", "2018-14665", EXPLOITXSIZE};

/* ============================ Global ============================== */

void scan_kernel_exploits(All_Results *ar);
static void test_exploit(All_Results *ar, PossibleExploit *pe, char *release);

/* ============================ Global ============================== */

/* STEP 4: Add the new struct to the total exploits array, Done*/

/* Array of pointers to the possible exploit structs */
PossibleExploit *TotalExploits[] = {
    &WootExploit, &BrkExploit, &AveExploit, &ElflblExploit, &ElfDumpExploit, &ElfcdExploit, &ExpandStackExploit, &H00lyShitExploit,
    &KdumpExploit, &Km2PwnExploit, &KradExploit, &Krad3Exploit, &Local26Exploit, &LokoExploit, &Mremap_pteExploit, &NewLocalExploit,
    &OngBakExploit, &PtraceExploit, &PtraceKmodExploit, &PtraceKmod2Exploit, &Ptrace24Exploit, &PwnedExploit, &Py2PwnExploit,
    &RaptorPrctlExploit, &PrctlExploit, &Prctl2Exploit, &Prctl3Exploit, &Prctl4Exploit, &RemapExploit, &RipPwnExploit, &StackGrow2Exploit,
    &UseLib24Exploit, &NewsmpExploit, &SnptracerExploit, &LoginxExploit, &ExpShExploit, &Vmsplice1Exploit, &Vmsplice2Exploit,
    &VconsoleExploit, &SctpExploit, &FtrexExploit, &ExitNotifyExploit, &UdevExploit, &SockSendPage2Exploit, &SockSendPageExploit,
    &UdpSendMsg32BitExploit, &PipeC32BitExploit, &DoPageMoveExploit, &ReiserfsExploit, &CanBcmExploit, &RdsPwnExploit, &HalfNelson1Exploit,
    &HalfNelson2Exploit, &HalfNelson3Exploit, &CapsToRootExploit, &AmericanSignLanguageExploit, &PktcdvdExploit, &Video4LinuxExploit,
    &MemodipperExploit, &SemTexExploit, &PerfSweventExploit, &MsrPwnExploit, &TimeOutPwnExploit, &RawModePTYExploit, &OverlayfsExploit,
    &PPKeyExploit, &DirtyCowExploit, &AfPacketExploit, &PacketSetRingExploit, &CloneNewUserExploit, &GetRektExploit, &ExploitXExploit};

/**
 * This scan will look check the kerenel version to see if it's out of datae 
 * if it is out date, then we will report any POC exploits that match the kerenel
 * version
 * @param ar This is the enumy results struct
 */
void scan_kernel_exploits(All_Results *ar)
{
    int number_of_exploits = sizeof TotalExploits / sizeof(TotalExploits[0]);
    struct utsname uname_struct;

    /* Get the kerenel information */
    if (uname(&uname_struct) != 0)
    {
        log_error_errno(ar, "Failed to run uname", errno);
        return;
    }

    char release_buf[MAXSIZE] = {'\0'};
    int release_size = strlen(uname_struct.release);
    char current;

    /* uname.release on some system returns  x.x.x and others returns x.x.x.xOS */
    /* We only care about the major, minor and patch number so we truncte the result if needed*/
    for (int i = 0; i < release_size; i++)
    {
        current = uname_struct.release[i];
        /* copy current character if its in the set {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, .} */
        if (((current >= 49) && (current <= 57)) || (current == '.'))
            release_buf[i] = uname_struct.release[i];
        else
            break;
    }

    /* Loop through all known exploits and test kernel version */
    for (int i = 0; i < number_of_exploits; i++)
    {
        PossibleExploit *current_exploit = TotalExploits[i];
        test_exploit(ar, current_exploit, release_buf);
    }
}

/** Report issue if the current possible exploit's kernel version matches the current kernel version
 *  @param ar Struct containing enumy's results
 *  @param pe Possible Exploit that we're testing
 *  @param relase The current kernels release
 */
static void test_exploit(All_Results *ar, PossibleExploit *pe, char *release)
{
    char issue_buf[MAXSIZE];

    char *unknown_url = "Unknown";
    char *no_cve = "N/a";

    const char *cve, *url;

    /* Loop through all known vulnerable kerenl versions */
    for (unsigned int i = 0; i < pe->vul_count; i++)
    {
        const char **vuln_vers = pe->vuln_versions;

        /* If kernel versions match raise as an issue */
        if (strcmp(vuln_vers[i], release) == 0)
        {
            cve = strcmp(pe->cve, "") == 0 ? no_cve : pe->cve;
            url = strcmp(pe->url, "") == 0 ? unknown_url : pe->url;

            memset(issue_buf, '\0', sizeof(issue_buf));
            snprintf(issue_buf, (sizeof(issue_buf) - 1),
                     "System could be vulnerable to kernel exploit: %s - URL: %s - CVE: %s",
                     pe->name, cve, url);

            add_issue(HIGH, CTF, "", ar, issue_buf, "");
        }
    }
}
